{% extends request.htmx|yesno:"base_htmx.html,base.html" %}

{% load date_utils %}

{% block page_title %}Bookings{% endblock %}

{% block subtitle %}
    <h2>Bookings {{ date|date:"l jS F Y" }}</h2>
{% endblock %}

{% block content %}
    <div id="day" hx-trigger="bookingdrop" hx-get="{{ request.path }}">
        <h1>Bookings {{ date|date:"l jS F Y" }}</h1>

        <ol x-data="{ errors: [] }">
            {% for time, bookings in booking_times %}
                <li>
                    <div>{{ time|date:"H:i" }}</div>
                    <div
                        class="dropzone"
                        :class="{ 'adding': adding }"
                        x-on:drop.prevent="{# fmt:off #}
                            const id = event.dataTransfer.getData('text/plain');
                            const { target } = event;
                            const container = target.querySelector('.booking-group') || target;
                            const element = document.getElementById(id);
                            const parent = element.parentElement;
                            container.appendChild(element);
                            adding = false;
                            removing = false;
                            fetch(element.dataset.moveUrl, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                                body: JSON.stringify({ to: target.dataset.time })
                            })
                            .then((r) => r.ok ? r : Promise.reject(r))
                            .then(() => $dispatch('bookingdrop', {id: element.dataset.id }))
                            .catch((err) => {
                                parent.appendChild(element);
                                err.json()
                                   .then((data) => errors.push(`Failed to move: ${data.detail}`))
                                   .then(() => setTimeout(() => errors.shift(), 3000));
                            });
                        {# fmt:on #}"
                        x-on:dragover.prevent="adding = true"
                        x-on:dragleave.prevent="adding = false"
                        x-data="{ adding: false, removing: false }"
                        data-time="{{ date|date:'Y-m-d' }}T{{ time|date:'H:i' }}:00{{ date|date:'O' }}"
                    >
                        {% if bookings %}
                            {% with slot=bookings.0.booking_slot %}
                                <div
                                    class="booking-group"
                                    :class="{ 'dragging': dragging }"
                                    draggable="true"
                                    id="booking-group-{{ slot.id }}"
                                    data-id="{{ slot.id }}"
                                    data-move-url="{% url 'bookingslot-move' slot.id %}"
                                    data-length="{{ slot.length_minutes }}"
                                    x-data="{ dragging: false }"
                                    x-on:dragend="dragging = false"
                                    x-on:dragstart.self="{# fmt:off #}
                                        dragging = true;
                                        event.dataTransfer.effectAllowed = 'move';
                                        event.dataTransfer.setData('text/plain', event.target.id);
                                    {# fmt:on #}"
                                >
                                    {% for booking in bookings %}
                                        <div
                                            id="booking-{{ booking.id }}"
                                            class="booking"
                                            :class="{ 'dragging': dragging }"
                                            draggable="true"
                                            x-data="{ dragging: false }"
                                            x-on:dragend="dragging = false"
                                            x-on:dragstart.self="{# fmt:off #}
                                                dragging = true;
                                                event.dataTransfer.effectAllowed = 'move';
                                                event.dataTransfer.setData('text/plain', event.target.id);
                                            {# fmt:on #}"
                                            data-length="{{ booking.length_minutes }}"
                                            data-id="{{ booking.id }}"
                                            data-move-url="{% url 'booking-move-booking' booking.id %}"
                                            style="--display-colour: {{ booking.service.display_colour }}"
                                        >{{ booking.pet }}</div>
                                    {% endfor %}
                                </div>
                            {% endwith %}
                        {% endif %}
                    </div>
                </li>
            {% endfor %}
            <template x-teleport="body">
                <div x-show="errors" class="toast-container">
                    <template x-for="error in errors">
                        <div x-text="error"></div>
                    </template>
                </div>
            </template>
        </ol>
    </div>
{% endblock %}
