{% extends request.htmx|yesno:"base_htmx.html,base.html" %}

{% load date_utils %}

{% block page_title %}Bookings{% endblock %}

{% block subtitle %}
    <h2>Bookings {{ date|date:"l jS F Y" }}</h2>
{% endblock %}

{% block content %}
    <div id="day" hx-trigger="bookingdrop" hx-get="{{ request.path }}">
        <h1>Bookings {{ date|date:"l jS F Y" }}</h1>

        <ol x-data>
            {% for time, bookings in booking_times %}
                <li>
                    <div>{{ time|date:"H:i" }}</div>
                    <div
                        class="dropzone"
                        :class="{ 'adding': adding }"
                        x-on:drop.prevent="
                                           const id = event.dataTransfer.getData('text/plain');
                                           const target = event.target.closest('.dropzone');
                                           const element = document.getElementById(id);
                                           target.appendChild(element);
                                           adding = false;
                                           removing = false;
                                           fetch(element.dataset.moveUrl, {
                                           method: 'PUT',
                                           headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                                           body: JSON.stringify({ to: target.dataset.time })
                                           }).then(() => $dispatch('bookingdrop', {id: element.dataset.id }));
                                          "
                        x-on:dragover.prevent="adding = true"
                        x-on:dragleave.prevent="adding = false"
                        x-data="{ adding: false, removing: false }"
                        data-time="{{ date|date:'Y-m-d' }}T{{ time|date:'H:i' }}:00{{ date|date:'O' }}"
                    >
                        {% for booking in bookings %}
                            <div
                                id="booking-{{ booking.id }}"
                                class="booking"
                                :class="{ 'dragging': dragging }"
                                draggable="true"
                                x-data="{ dragging: false }"
                                x-on:dragend="dragging = false"
                                x-on:dragstart.self="
                                                     dragging = true;
                                                     event.dataTransfer.effectAllowed = 'move';
                                                     event.dataTransfer.setData('text/plain', event.target.id);
                                                    "
                                data-length="{{ booking.length_minutes }}"
                                data-id="{{ booking.id }}"
                                data-move-url="{% url 'booking-move-booking' booking.id %}"
                                style="--display-colour: {{ booking.service.display_colour }}"
                            >{{ booking.pet }}</div>
                        {% endfor %}
                    </div>
                </li>
            {% endfor %}
        </ol>
    </div>
{% endblock %}
