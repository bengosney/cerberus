<div class="tag-input" x-effect="lookupTag(current)" x-data="{{# fmt:off #}
    current: '',
    active: false,
    canBlur: true,
    tags: [{{ tags }}],
    lookedUp: [],
    addTag(tag) {
        if (!tag) return;
        this.tags.push(tag);
        this.current = '';
    },
    async lookupTag(value) {
        this.lookedUp = value ? await fetchTags('{% url 'tag-list' %}', value) : [];
    },
    tab(event) {
        if (!this.lookedUp.length) return;
        this.addTag(this.lookedUp[0]);
        event.preventDefault()
    },
    blur() {
        if (!this.canBlur) return;
        this.active = false;
        this.addTag(this.current);
    }
{# fmt:on #}}">
    <div class="tag-container">
        <template x-for="tag in tags">
            <span class="tag">
                <span x-text="tag"></span>
                <span class="tag-close" @click="tags = tags.filter(t => t != tag)">&#x2715;</span>
            </span>
        </template>
    </div>
    <input
        type="{{ widget.type }}"
        {% include "django/forms/widgets/attrs.html" %}
        @keydown.prevent.enter="addTag(current)"
        @keydown.tab="tab($event)"
        @focus="active = true"
        @blur="blur()"
        x-model="current"
        x-ref="input"
        autocomplete="off"
    >
    <div class="tag-lookup" x-show="lookedUp.length && active" x-transition>
        <ul role="listbox">
            <template x-for="tag in lookedUp">
                <li>
                    <a
                        x-text="tag"
                        @mousedown="canBlur = false"
                        @click.prevent="addTag(tag);$focus.focus($refs.input)"
                        @mouseup="canBlur = true"
                        href="#">
                    </a>
                </li>
            </template>
        </ul>
    </div>
    <input name="{{ widget.name }}" type="hidden" x-model="tags" readonly />
</div>
